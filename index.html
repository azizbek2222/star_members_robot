<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Market - Professional</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root { --main: #01875f; --bg: #f1f3f4; }
        body { font-family: 'Roboto', sans-serif; margin: 0; background: var(--bg); -webkit-tap-highlight-color: transparent; }
        
        header { 
            background: white; 
            padding: 12px 16px; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            box-shadow: 0 1px 4px rgba(0,0,0,0.1); 
            display: flex; 
            align-items: center; 
            gap: 12px;
        }

        .search-box { 
            background: #f1f3f4; 
            border-radius: 24px; 
            padding: 5px 15px; 
            flex-grow: 1; 
            display: flex; 
            align-items: center; 
        }
        .search-box input { border: none; background: transparent; outline: none; width: 100%; padding: 10px; font-size: 16px; }

        /* Market ikonkasi uchun stil */
        .market-btn {
            width: 35px;
            height: 35px;
            cursor: pointer;
            transition: transform 0.2s;
            object-fit: contain;
        }
        .market-btn:active { transform: scale(0.9); }

        .container { padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 20px; }
        .app-item { text-align: center; cursor: pointer; }
        .app-item img { width: 90px; height: 90px; border-radius: 22%; object-fit: cover; box-shadow: 0 2px 6px rgba(0,0,0,0.1); background: white; }
        .app-item div { font-size: 13px; margin-top: 8px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* PLAY MARKET MODAL STYLE */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; display: none; flex-direction: column; overflow-y: auto; }
        .m-header { padding: 15px; font-size: 24px; cursor: pointer; position: sticky; top: 0; background: white; z-index: 10; }
        
        .m-top-info { display: flex; padding: 20px; gap: 20px; align-items: center; }
        .m-icon-big { width: 100px; height: 100px; border-radius: 22%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .m-title-area h2 { margin: 0; font-size: 22px; }
        .m-title-area p { margin: 5px 0; color: var(--main); font-weight: 500; }

        .btn-install { background: var(--main); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 16px; font-weight: 500; cursor: pointer; width: calc(100% - 40px); margin: 0 20px; }
        
        .screenshot-gallery { display: flex; overflow-x: auto; gap: 10px; padding: 20px; scrollbar-width: none; }
        .screenshot-gallery::-webkit-scrollbar { display: none; }
        .screenshot-gallery img { height: 200px; border-radius: 12px; border: 1px solid #eee; }

        .description { padding: 20px; line-height: 1.6; color: #5f6368; font-size: 14px; border-top: 1px solid #eee; }
        
        .p-container { padding: 0 20px; margin-top: 10px; display: none; }
        .p-bar-bg { width: 100%; height: 6px; background: #eee; border-radius: 10px; overflow: hidden; }
        .p-bar-fill { width: 0%; height: 100%; background: var(--main); transition: 0.1s; }
    </style>
</head>
<body>

<header>
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Ilovalarni qidirish..." oninput="searchApps()">
    </div>
    <img src="market.png" class="market-btn" alt="Settings" onclick="location.href='settings.html'">
</header>

<div class="container" id="appGrid"></div>

<div id="appModal" class="modal">
    <div class="m-header" onclick="closeModal()">⬅️</div>
    
    <div class="m-top-info">
        <img id="mIcon" class="m-icon-big">
        <div class="m-title-area">
            <h2 id="mName"></h2>
            <p>Star Market • Ilova</p>
        </div>
    </div>

    <button class="btn-install" id="btnGo" onclick="startInstall()">O'rnatish</button>
    
    <div class="p-container" id="pCont">
        <div class="p-bar-bg"><div class="p-bar-fill" id="pBar"></div></div>
        <div id="status" style="font-size: 12px; margin-top: 5px; color: #666;"></div>
    </div>

    <div class="screenshot-gallery" id="mScreens"></div>

    <div class="description" id="mDesc"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA7VLHdjPqf_tobSiBczGbN8H7YlFwq9Wg",
        authDomain: "magnetic-alloy-467611-u7.firebaseapp.com",
        databaseURL: "https://magnetic-alloy-467611-u7-default-rtdb.firebaseio.com",
        projectId: "magnetic-alloy-467611-u7",
        storageBucket: "magnetic-alloy-467611-u7.firebasestorage.app",
        messagingSenderId: "589500919880",
        appId: "1:589500919880:web:7b82d037c5e7396d51687d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let appsList = [];
    let selectedApp = {};

    // Bazadan ma'lumotlarni olish
    db.ref('apps').on('value', snap => {
        appsList = [];
        const grid = document.getElementById('appGrid');
        grid.innerHTML = "";
        snap.forEach(child => {
            const app = child.val();
            app.id = child.key;
            appsList.push(app);
            renderApp(app);
        });
    });

    function renderApp(app) {
        const grid = document.getElementById('appGrid');
        grid.innerHTML += `
            <div class="app-item" onclick="openModal('${app.id}')">
                <img src="${app.image}">
                <div>${app.name}</div>
            </div>`;
    }

    // Qidiruv funksiyasi
    function searchApps() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const grid = document.getElementById('appGrid');
        grid.innerHTML = "";
        const filtered = appsList.filter(a => a.name.toLowerCase().includes(query));
        filtered.forEach(app => renderApp(app));
    }

    function openModal(id) {
        selectedApp = appsList.find(a => a.id === id);
        document.getElementById('mName').innerText = selectedApp.name;
        document.getElementById('mIcon').src = selectedApp.image;
        document.getElementById('mDesc').innerText = selectedApp.desc || "Tavsif mavjud emas.";
        
        const screenDiv = document.getElementById('mScreens');
        screenDiv.innerHTML = "";
        if(selectedApp.screenshots) {
            selectedApp.screenshots.forEach(src => {
                screenDiv.innerHTML += `<img src="${src}">`;
            });
        }
        
        document.getElementById('appModal').style.display = 'flex';
        resetDownloadUI();
    }

    function closeModal() { document.getElementById('appModal').style.display = 'none'; }
    
    function resetDownloadUI() {
        document.getElementById('btnGo').style.display = 'block';
        document.getElementById('pCont').style.display = 'none';
        document.getElementById('pBar').style.width = '0%';
    }

    async function startInstall() {
        const btn = document.getElementById('btnGo');
        const pCont = document.getElementById('pCont');
        const pBar = document.getElementById('pBar');
        const status = document.getElementById('status');

        btn.style.display = 'none';
        pCont.style.display = 'block';

        try {
            const res = await fetch(selectedApp.link, { redirect: 'follow' });
            const reader = res.body.getReader();
            const total = +res.headers.get('Content-Length');
            let received = 0, chunks = [];

            while(true) {
                const {done, value} = await reader.read();
                if(done) break;
                chunks.push(value);
                received += value.length;
                if(total) {
                    let p = (received / total) * 100;
                    pBar.style.width = p + '%';
                    status.innerText = `Yuklanmoqda: ${Math.round(p)}%`;
                }
            }
            const blob = new Blob(chunks);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = selectedApp.name + ".apk";
            a.click();
            status.innerText = "Yuklab olindi!";
        } catch(e) { 
            window.location.href = selectedApp.link;
        }
    }
</script>
</body>
</html>